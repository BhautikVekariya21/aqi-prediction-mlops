# =============================================================================
# API TESTING WORKFLOW
# Tests API endpoints after deployment
# =============================================================================

name: Test API

on:
  workflow_dispatch:
    inputs:
      api_url:
        description: 'API URL to test'
        required: true
        default: 'http://localhost:8000'
  workflow_run:
    workflows: ["Deploy to Railway"]
    types:
      - completed

jobs:
  test-api:
    name: Test API Endpoints
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Wait for deployment
        run: |
          echo "Waiting 30 seconds for deployment to stabilize..."
          sleep 30
      
      - name: Test health endpoint
        run: |
          API_URL="${{ github.event.inputs.api_url || secrets.RAILWAY_API_URL }}"
          echo "Testing: $API_URL/health"
          
          response=$(curl -s -w "\n%{http_code}" "$API_URL/health")
          status_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)
          
          if [ "$status_code" -eq 200 ]; then
            echo "✓ Health check passed"
            echo "$body"
          else
            echo "✗ Health check failed (HTTP $status_code)"
            exit 1
          fi
      
      - name: Test cities endpoint
        run: |
          API_URL="${{ github.event.inputs.api_url || secrets.RAILWAY_API_URL }}"
          echo "Testing: $API_URL/cities"
          
          response=$(curl -s -w "\n%{http_code}" "$API_URL/cities")
          status_code=$(echo "$response" | tail -n1)
          
          if [ "$status_code" -eq 200 ]; then
            echo "✓ Cities endpoint passed"
          else
            echo "✗ Cities endpoint failed (HTTP $status_code)"
            exit 1
          fi
      
      - name: Test prediction endpoint
        run: |
          API_URL="${{ github.event.inputs.api_url || secrets.RAILWAY_API_URL }}"
          echo "Testing: $API_URL/predict"
          
          response=$(curl -s -w "\n%{http_code}" -X POST "$API_URL/predict" \
            -H "Content-Type: application/json" \
            -d '{
              "city": "Delhi",
              "pm2_5": 150,
              "pm10": 250,
              "o3": 80,
              "no2": 60,
              "humidity": 65
            }')
          
          status_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)
          
          if [ "$status_code" -eq 200 ]; then
            echo "✓ Prediction endpoint passed"
            echo "$body"
          else
            echo "✗ Prediction endpoint failed (HTTP $status_code)"
            echo "$body"
            exit 1
          fi
      
      - name: Test forecast endpoint
        run: |
          API_URL="${{ github.event.inputs.api_url || secrets.RAILWAY_API_URL }}"
          echo "Testing: $API_URL/forecast"
          
          response=$(curl -s -w "\n%{http_code}" -X POST "$API_URL/forecast" \
            -H "Content-Type: application/json" \
            -d '{
              "city": "Mumbai",
              "forecast_days": 2
            }')
          
          status_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)
          
          if [ "$status_code" -eq 200 ]; then
            echo "✓ Forecast endpoint passed"
            echo "$body"
          else
            echo "⚠ Forecast endpoint failed (HTTP $status_code)"
            echo "$body"
            # Don't fail - forecast depends on external API
          fi
        continue-on-error: true