name: Validate Model

on:
  workflow_dispatch:
  push:
    paths:
      - "models/optimized/**"

jobs:
  validate-model:
    name: Validate Model Files
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          pip install -q xgboost joblib scikit-learn

      - name: Check model files exist
        id: check_files
        run: |
          echo "✓ Checking model files..."

          # Check for PKL or JSON.gz and set environment variable for subsequent steps
          if [ -f "models/optimized/model_final.pkl" ]; then
            echo "✓ model_final.pkl found"
            echo "MODEL_FILE=models/optimized/model_final.pkl" >> $GITHUB_ENV
          elif [ -f "models/optimized/model.json.gz" ]; then
            echo "✓ model.json.gz found"
            echo "MODEL_FILE=models/optimized/model.json.gz" >> $GITHUB_ENV
          else
            echo "✗ No model file found"
            exit 1
          fi

          if [ -f "models/optimized/features.txt" ]; then
            FEATURE_COUNT=$(wc -l < models/optimized/features.txt)
            echo "✓ Features file found ($FEATURE_COUNT features)"
          else
            echo "✗ features.txt missing"
            exit 1
          fi

      - name: Test model loading
        run: |
          python << 'EOF'
          import joblib
          import xgboost as xgb
          import sys
          import os

          model_path = os.getenv('MODEL_FILE')
          print(f'Attempting to load: {model_path}')

          try:
              if model_path.endswith('.pkl'):
                  model = joblib.load(model_path)
                  print(f'✓ Pickle Model loaded: {type(model).__name__}')
              elif model_path.endswith('.json.gz') or model_path.endswith('.json'):
                  model = xgb.Booster()
                  model.load_model(model_path)
                  print(f'✓ XGBoost JSON Model loaded')
              else:
                  print('✗ Unknown model format')
                  sys.exit(1)
          except Exception as e:
              print(f'✗ Failed to load model: {e}')
              sys.exit(1)

          print('Loading features...')
          try:
              with open('models/optimized/features.txt', 'r') as f:
                  features = [line.strip() for line in f.readlines()]
              print(f'✓ Features loaded: {len(features)} features')
          except Exception as e:
              print(f'✗ Failed to read features: {e}')
              sys.exit(1)
          EOF

      - name: Check model size
        run: |
          # Use the environment variable set in the first step
          echo "Checking size for: $MODEL_FILE"

          SIZE=$(du -m "$MODEL_FILE" | cut -f1)

          if [ "$SIZE" -gt 0 ]; then
            echo "Model size: ${SIZE}MB"
            if [ "$SIZE" -gt 100 ]; then
              echo "⚠ Warning: Large model (${SIZE}MB)"
            else
              echo "✓ Model size OK"
            fi
          else
            echo "✗ Error reading file size"
            exit 1
          fi
