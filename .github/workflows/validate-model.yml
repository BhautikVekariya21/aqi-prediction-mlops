name: Validate Model

on:
  workflow_dispatch:
  push:
    paths:
      - 'models/optimized/**'

jobs:
  validate-model:
    name: Validate Optimized Model
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
      
      - name: Install dependencies
        # Added scikit-learn as it is usually required for reading pickle files
        run: |
          pip install xgboost joblib scikit-learn
      
      - name: Check model files
        run: |
          echo "Checking model files..."
          
          # Check PKL model
          if [ -f "models/optimized/model_final.pkl" ]; then
            echo "✓ model_final.pkl found"
            ls -lh models/optimized/model_final.pkl
          else
            echo "✗ model_final.pkl missing"
            exit 1
          fi
          
          # Check features
          if [ -f "models/optimized/features.txt" ]; then
            echo "✓ features.txt found"
            wc -l models/optimized/features.txt
          else
            echo "✗ features.txt missing"
            exit 1
          fi
          
          # Check metadata
          if [ -f "models/optimized/model_metadata.json" ]; then
            echo "✓ model_metadata.json found"
            cat models/optimized/model_metadata.json
          else
            echo "⚠ model_metadata.json missing (optional)"
          fi
      
      - name: Test model loading
        # Using 'shell: python' avoids quote escaping issues common with 'python -c'
        shell: python
        run: |
          import joblib
          import sys
          import os

          print('Loading model...')
          try:
              # Ensure the path is correct relative to where the script runs
              model_path = 'models/optimized/model_final.pkl'
              if not os.path.exists(model_path):
                  raise FileNotFoundError(f"{model_path} does not exist")

              model = joblib.load(model_path)
              print('✓ Model loaded successfully')
              print(f'Model type: {type(model).__name__}')
          except Exception as e:
              print(f'✗ Failed to load model: {e}')
              sys.exit(1)

          print('Loading features...')
          try:
              with open('models/optimized/features.txt', 'r') as f:
                  features = [line.strip() for line in f.readlines()]
              print(f'✓ Features loaded: {len(features)} features')
          except Exception as e:
              print(f'✗ Failed to load features: {e}')
              sys.exit(1)
      
      - name: Check model size
        run: |
          SIZE=$(du -m models/optimized/model_final.pkl | cut -f1)
          echo "Model size: ${SIZE}MB"
          
          if [ $SIZE -gt 50 ]; then
            echo "⚠ Warning: Model size exceeds 50MB (${SIZE}MB)"
            echo "Consider using model.json.gz for smaller size"
          else
            echo "✓ Model size is acceptable for Railway deployment"
          fi