name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.10"
  # Replace 'bhautikvekariya21' with your HF username and 'aqi-prediction-mlops' with your Space name
  HF_USERNAME: "bhautikvekariya21"
  HF_SPACE_NAME: "aqi-prediction-mlops"

jobs:
  # ---------------------------------------------------------------------------
  # JOB 1: VERIFY FILES (CI)
  # ---------------------------------------------------------------------------
  verify-deployment:
    name: Verify Files
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          lfs: true # Important for large model files

      - name: Check essential files
        run: |
          echo "âœ“ Checking deployment files..."

          # Check Dockerfile (Required for Hugging Face)
          if [ -f "Dockerfile" ]; then
            echo "âœ“ Dockerfile found"
          else
            echo "âœ— Dockerfile missing"
            exit 1
          fi

          # Check requirements.txt
          if [ -f "requirements.txt" ]; then
            echo "âœ“ requirements.txt found"
          else
            echo "âœ— requirements.txt missing"
            exit 1
          fi

          # Check main API file (app.py)
          if [ -f "app.py" ]; then
            echo "âœ“ app.py found"
          else
            echo "âœ— app.py missing"
            exit 1
          fi

      - name: Check model files
        run: |
          echo "âœ“ Checking model files..."

          # Check for model in root (where your code expects it now)
          if [ -f "model.json.gz" ]; then
             echo "âœ“ model.json.gz found in root"
          elif [ -f "models/optimized/model.json.gz" ]; then
             echo "âœ“ model.json.gz found in models/optimized/"
          else
             echo "âœ— No model file found!"
             exit 1
          fi

  # ---------------------------------------------------------------------------
  # JOB 2: DEPLOY TO HUGGING FACE (CD)
  # ---------------------------------------------------------------------------
  deploy-to-hf:
    name: Deploy to Hugging Face
    needs: verify-deployment
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' # Only deploy on push to main

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          lfs: true

      - name: Push to Hugging Face Hub
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          echo "ðŸš€ Pushing to Hugging Face Space..."

          # 1. Install git-lfs
          git lfs install

          # 2. Add Hugging Face remote
          # Using the token directly in the URL for authentication
          git remote add space https://$HF_USERNAME:$HF_TOKEN@huggingface.co/spaces/$HF_USERNAME/$HF_SPACE_NAME

          # 3. Force push main branch to the Space
          # We use --force to overwrite the Space with exactly what is in GitHub
          git push --force space main

          echo "âœ… Deployed successfully!"
