name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.10"
  HF_USERNAME: "bhautikvekariya21"
  HF_SPACE_NAME: "aqi-prediction-mlops"

jobs:
  deploy-to-hf:
    name: Deploy to Hugging Face
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Hugging Face Hub
        run: pip install huggingface_hub

      - name: Prepare Files (Move Model to Root)
        run: |
          # 1. Check if model exists in the subfolder and move it to root
          if [ -f "models/optimized/model.json.gz" ]; then
            echo "üì¶ Moving model from subfolder to root..."
            mv models/optimized/model.json.gz .
          fi

          # 2. Verify model is in root now
          if [ -f "model.json.gz" ]; then
            echo "‚úÖ Model found in root directory"
          else
            echo "‚ùå Model missing! Deployment will fail."
            ls -R
            exit 1
          fi

      - name: Upload to Hugging Face
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          echo "üöÄ Uploading files to Hugging Face Space..."

          # FIX: Run via python module to avoid 'command not found' error
          python -m huggingface_hub.cli upload $HF_USERNAME/$HF_SPACE_NAME . . --repo-type space --token $HF_TOKEN --exclude ".git/*" ".github/*"

          echo "‚úÖ Deployed successfully!"
