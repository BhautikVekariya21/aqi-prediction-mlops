name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.10"
  HF_USERNAME: "bhautikvekariya21"
  HF_SPACE_NAME: "aqi-prediction-mlops"

jobs:
  # ---------------------------------------------------------------------------
  # JOB 1: VERIFY FILES
  # ---------------------------------------------------------------------------
  verify-deployment:
    name: Verify Files
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check essential files
        run: |
          echo "âœ“ Checking deployment files..."
          if [ ! -f "Dockerfile" ]; then echo "âœ— Dockerfile missing"; exit 1; fi
          if [ ! -f "requirements.txt" ]; then echo "âœ— requirements.txt missing"; exit 1; fi
          if [ ! -f "app.py" ]; then echo "âœ— app.py missing"; exit 1; fi
          echo "âœ“ All essential files present"

  # ---------------------------------------------------------------------------
  # JOB 2: DEPLOY TO HUGGING FACE (Using Python CLI)
  # ---------------------------------------------------------------------------
  deploy-to-hf:
    name: Deploy to Hugging Face
    needs: verify-deployment
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Hugging Face Hub
        run: pip install huggingface_hub

      - name: Upload to Space
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          echo "ðŸš€ Uploading files to Hugging Face..."

          # This command uploads the current folder (.) to the root of the Space (.)
          # It automatically handles large files like model.json.gz without errors.
          huggingface-cli upload $HF_USERNAME/$HF_SPACE_NAME . . --repo-type space --token $HF_TOKEN

          echo "âœ… Deployed successfully!"
